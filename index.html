<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Saúde do Grupo (Consórcio)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1216; --card:#151a21; --muted:#8aa0b6; --text:#e8eef6;
      --ok:#19a974; --warn:#f7b801; --bad:#ef476f;
      --gold:gold; --green:green;
      --grid-gap:6px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:16px; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell;
      background:var(--bg); color:var(--text);
    }
    h1{margin:0 0 8px 0; font-size:22px}
    .sub{color:var(--muted); font-size:12px; margin-bottom:16px}
    .wrap{display:grid; gap:12px}
    .cards{
      display:grid; grid-template-columns:repeat(4,minmax(200px,1fr)); gap:12px;
    }
    .card{
      background:var(--card); border:1px solid #202833; border-radius:12px; padding:14px;
      box-shadow:0 1px 0 rgba(255,255,255,0.03) inset, 0 10px 30px rgba(0,0,0,0.25);
    }
    .k-title{font-size:12px; color:var(--muted)}
    .k-value{font-size:22px; font-weight:700; margin-top:4px}
    .k-foot{font-size:11px; color:var(--muted); margin-top:6px}

    .bars{display:flex; gap:8px; align-items:flex-end; height:120px; padding:10px 6px}
    .bar{flex:1; background:#253041; border-radius:6px 6px 0 0; position:relative}
    .bar > span{
      position:absolute; bottom:0; left:0; right:0; height:0%;
      background:#4b89ff; border-radius:6px 6px 0 0; transition:height .6s ease;
    }
    .bar-label{font-size:11px; color:var(--muted); text-align:center; margin-top:6px; min-height:1em}
    .bar-num{font-size:12px; text-align:center; margin-top:2px}

    .two-col{display:grid; grid-template-columns: 1.3fr .7fr; gap:12px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}

    .grid{
      display:grid; grid-template-columns: repeat(10, 1fr);
      gap: var(--grid-gap);
      max-height:540px; overflow:auto; padding:6px; background:#0c0f13; border-radius:12px; border:1px solid #202833;
    }
    .cell{
      border:1px solid #2a3544; padding:8px 6px; text-align:center; font-size:11px; border-radius:8px; color:#bccde1;
      background:#121821;
    }
    .sorteio{ background-color: var(--gold); color:#1b1b1b; font-weight:700 }
    .lance{ background-color: var(--green); color:white; font-weight:700 }

    .legend{display:flex; gap:10px; font-size:12px; color:var(--muted); align-items:center}
    .dot{width:10px; height:10px; border-radius:3px; display:inline-block; vertical-align:middle}
    .dot-gold{ background:var(--gold)}
    .dot-green{ background:var(--green)}

    .list{margin-top:8px; display:grid; gap:6px; max-height:200px; overflow:auto}
    .pill{display:inline-block; background:#1a2330; border:1px solid #273246; padding:4px 8px; border-radius:999px; font-size:12px; color:#b9cee6}

    .donut-wrap{
      display:flex; align-items:center; justify-content:center;
      height:220px; margin-top:4px; margin-bottom:2px;
    }
    .donut{
      width:220px; height:220px;
      transform:rotate(-90deg);
    }
    .donut text{
      font-size:18px; font-weight:700; fill:#e8eef6;
      transform:rotate(90deg); text-anchor:middle; dominant-baseline:middle;
    }
    .donut-legend{
      display:flex; gap:12px; justify-content:center; margin-top:6px; font-size:12px; color:#8aa0b6;
    }
    .legend-item{display:flex; align-items:center; gap:6px}
    .legend-swatch{width:10px; height:10px; border-radius:3px}
    .swatch-lance{background:green}
    .swatch-sorteio{background:gold}

    #ll-cota-table .rowline{
      display:grid; grid-template-columns: 80px 1fr 120px; gap:10px;
      padding:6px 8px; border:1px solid #273246; background:#0f1622; border-radius:8px;
    }
    .badge{ display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; }
    .badge-win{ background:rgba(25,169,116,.15); border:1px solid #19a974; color:#c2f3e2 }
    .badge-pre{ background:#1a2330; border:1px solid #273246; color:#b9cee6 }
    .svgblk{ width:100%; height:160px; }

    @media (max-width:1100px){
      .cards{grid-template-columns:repeat(2,minmax(160px,1fr))}
      .two-col{grid-template-columns: 1fr}
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <h1>Saúde do Grupo</h1>
  <div class="sub">Visão financeira e operacional do consórcio (Disponibilidades, Coleta/Utilização, Contemplações e Grade de Cotas).</div>

  <div class="wrap">

    <!-- KPIs -->
    <section class="cards" id="kpis">
      <div class="card">
        <div class="k-title">Disponibilidades (último fechamento)</div>
        <div class="k-value" id="kpi-dispon"></div>
        <div class="k-foot" id="kpi-dispon-ref"></div>
      </div>
      <div class="card">
        <div class="k-title">(+ ) Recursos Coletados (mês)</div>
        <div class="k-value" id="kpi-coletado"></div>
        <div class="k-foot" id="kpi-coletado-acc"></div>
      </div>
      <div class="card">
        <div class="k-title">(-) Recursos Utilizados (mês)</div>
        <div class="k-value" id="kpi-utilizado"></div>
        <div class="k-foot" id="kpi-utilizado-acc"></div>
      </div>
      <div class="card">
        <div class="k-title">Saldo do Mês (Coletado - Utilizado)</div>
        <div class="k-value" id="kpi-saldo"></div>
        <div class="k-foot" id="kpi-mix"></div>
      </div>
    </section>

    <section class="two-col">
      <!-- Mix Lance x Sorteio + parcela média -->
      <div class="card">
        <div class="k-title">Mix de Contemplações</div>

        <div id="mix-vis" class="donut-wrap" aria-label="Rosca Lance x Sorteio"></div>

        <div class="bars" id="bars-mix" aria-label="Gráfico de barras: Lance x Sorteio">
          <div class="bar" title="Lance"><span id="bar-lance"></span></div>
          <div class="bar" title="Sorteio"><span id="bar-sorteio"></span></div>
        </div>

        <div class="row">
          <div>
            <div class="bar-label">Lance</div>
            <div class="bar-num" id="num-lance">0</div>
          </div>
          <div>
            <div class="bar-label">Sorteio</div>
            <div class="bar-num" id="num-sorteio">0</div>
          </div>
        </div>
        <div class="k-foot" id="parcela-media">Parcela média na contemplação: —</div>
      </div>

      <!-- Contemplações por Assembleia -->
      <div class="card">
        <div class="k-title">Contemplações por Assembleia</div>
        <div class="bars" id="bars-assem" aria-label="Barras por assembleia"></div>
        <div class="list" id="labels-assem"></div>
      </div>
    </section>

    <!-- Lances Livres -->
    <section class="card">
      <div style="display:flex; gap:12px; align-items:end; flex-wrap:wrap; justify-content:space-between">
        <div>
          <div class="k-title">Lances Livres até a Contemplação</div>
          <div class="sub">Analise por cota (timeline) e resumo por assembleia</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <label style="font-size:12px; color:#8aa0b6">Cota</label>
          <input id="ll-cota-input" placeholder="ex.: 0074-00 ou 74" style="background:#0c0f13;color:#e8eef6;border:1px solid #273246;border-radius:8px;padding:6px 10px;outline:none">
          <button id="ll-cota-btn" style="background:#1e293b;color:#e8eef6;border:1px solid #304156;border-radius:8px;padding:6px 10px;cursor:pointer">Analisar</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div id="ll-cota-panel" class="card" style="min-height:220px">
          <div class="k-title">Timeline da Cota</div>
          <div id="ll-cota-metrics" class="sub" style="margin-top:6px">—</div>
          <div id="ll-cota-chart" style="margin-top:10px"></div>
          <div id="ll-cota-table" class="list" style="margin-top:10px"></div>
        </div>

        <div class="card" style="min-height:220px">
          <div class="k-title">Resumo por Assembleia (grupo)</div>
          <div id="ll-assem-chart" style="margin-top:10px"></div>
          <div id="ll-assem-legend" class="legend" style="margin-top:8px">
            <span class="dot" style="background:#4b89ff"></span> Lances
            <span class="dot dot-green"></span> Contemplações por Lance
          </div>
        </div>
      </div>
    </section>

    <!-- Grade de cotas -->
    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <div class="k-title">Grade de Cotas (1 a 2000)</div>
        <div class="legend">
          <span class="dot dot-green"></span> Lance
          <span class="dot dot-gold"></span> Sorteio
          <span class="pill" id="pill-total"></span>
        </div>
      </div>
      <div class="grid" id="grid"></div>
    </section>

    <section class="card">
      <div class="k-title">Fontes</div>
      <div class="sub">Demonstrativo financeiro do grupo, contemplações e lances livres extraídos dos arquivos JSON anexados.</div>
    </section>
  </div>

  <script>
    // ===== Utils =====
    const BRL = v => (isNaN(v)? '—' : v.toLocaleString('pt-BR',{style:'currency', currency:'BRL'}));
    const pct = (a,b) => b>0 ? Math.round((a/b)*100) : 0;
    const toNumberBR = s => {
      if (s == null) return 0;
      return parseFloat(String(s).replace(/\./g,'').replace(',','.')) || 0;
    };
    const normalizeLabel = s => String(s||'').replace(/\.+/g, ' ').replace(/\s{2,}/g, ' ').trim();

    const safeFetchJson = async (path) => {
      const r = await fetch(encodeURI(path));
      if(!r.ok) throw new Error('Falha ao carregar '+path);
      return r.json();
    };

    // ===== DOM refs =====
    const kpiDispon = document.getElementById('kpi-dispon');
    const kpiDisponRef = document.getElementById('kpi-dispon-ref');
    const kpiColetado = document.getElementById('kpi-coletado');
    const kpiColetadoAcc = document.getElementById('kpi-coletado-acc');
    const kpiUtilizado = document.getElementById('kpi-utilizado');
    const kpiUtilizadoAcc = document.getElementById('kpi-utilizado-acc');
    const kpiSaldo = document.getElementById('kpi-saldo');
    const kpiMix = document.getElementById('kpi-mix');

    const barLance = document.getElementById('bar-lance');
    const barSorteio = document.getElementById('bar-sorteio');
    const numLance = document.getElementById('num-lance');
    const numSorteio = document.getElementById('num-sorteio');
    const parcelaMedia = document.getElementById('parcela-media');

    const barsAssem = document.getElementById('bars-assem');
    const labelsAssem = document.getElementById('labels-assem');

    const grid = document.getElementById('grid');
    const pillTotal = document.getElementById('pill-total');

    // ===== Grade base 1..2000 =====
    const totalCelulas = 2000;
    if (grid && !grid.children.length){
      for (let i = 1; i <= totalCelulas; i++) {
        const cell = document.createElement('div');
        cell.classList.add('cell');
        cell.id = 'cell-' + i;
        cell.textContent = i;
        grid.appendChild(cell);
      }
      const cell1603 = document.getElementById('cell-1603');
      if (cell1603) cell1603.style.border = '2px solid #2c7df5';
    }

    // ===== Carregar dados =====
    Promise.all([
      safeFetchJson('DemonstrativoGrupo.json'),
      safeFetchJson('Contemplacoes.json'),
      safeFetchJson('LancesLivres.json'),
    ])
    .then(([demonstrativo, contemplacoes, lancesLivres]) => {
      // ---------- FINANCEIRO ----------
      const demoNorm = demonstrativo.map(x => ({ ...x, _label: normalizeLabel(x['Discriminação']) }));

      const dispRows = demoNorm.filter(r => /Disponibilidades \(Em:\s*\d{2}\/\d{2}\/\d{4}\)/i.test(r._label));
      const lastDisp = dispRows[dispRows.length-1];
      const dispLabel = lastDisp? lastDisp._label : '';
      const dispValor = lastDisp? toNumberBR(lastDisp['Saldo do Período']) : 0;

      const rowColet = demoNorm.find(r => /^\(\+\)?\s*Recursos\s*Coletados/i.test(r._label));
      const coletPeriodo = toNumberBR(rowColet?.['Saldo do Período']);
      const coletAcc = toNumberBR(rowColet?.['Saldo Acumulado']);

      const rowUtil = demoNorm.find(r => /^\(-\)\s*Recursos\s*Utilizados/i.test(r._label));
      const utilPeriodo = toNumberBR(rowUtil?.['Saldo do Período']);
      const utilAcc = toNumberBR(rowUtil?.['Saldo Acumulado']);

      kpiDispon.textContent = BRL(dispValor);
      kpiDisponRef.textContent = dispLabel || '—';
      kpiColetado.textContent = BRL(coletPeriodo);
      kpiColetadoAcc.textContent = 'Acumulado: ' + BRL(coletAcc);
      kpiUtilizado.textContent = BRL(utilPeriodo);
      kpiUtilizadoAcc.textContent = 'Acumulado: ' + BRL(utilAcc);
      kpiSaldo.textContent = BRL(coletPeriodo - utilPeriodo);

      // ---------- CONTEMPLAÇÕES ----------
      const tipoCounts = { Lance:0, Sorteio:0 };
      let somaParcela = 0, contParcela = 0;

      contemplacoes.forEach(item => {
        const tipo = String(item.Tipo||'').trim();
        if (tipoCounts.hasOwnProperty(tipo)) tipoCounts[tipo]++;
        const parc = parseInt(item.Parc || item['Parc.'] || item['Parcela'] || '0', 10);
        if (!isNaN(parc) && parc>0){ somaParcela += parc; contParcela++; }
      });

      const totalCont = (tipoCounts.Lance || 0) + (tipoCounts.Sorteio || 0);
      const pLance = pct(tipoCounts.Lance, totalCont);
      const pSorteio = pct(tipoCounts.Sorteio, totalCont);

      barLance.style.height = pLance + '%';
      barSorteio.style.height = pSorteio + '%';
      numLance.textContent = `${tipoCounts.Lance} (${pLance}%)`;
      numSorteio.textContent = `${tipoCounts.Sorteio} (${pSorteio}%)`;
      parcelaMedia.textContent = 'Parcela média na contemplação: ' + (contParcela>0 ? Math.round(somaParcela/contParcela) : `—`;
      kpiMix.textContent = `Mix: Lance ${pLance}% · Sorteio ${pSorteio}% (total ${totalCont})`;

      renderDonutMix(pLance, pSorteio);

      // --- Contemplações por assembleia (card da direita)
      const contPorAssem = {};
      contemplacoes.forEach(i=>{
        const a = String(i.Assembleia||'').trim();
        if(!a) return;
        contPorAssem[a] = (contPorAssem[a]||0)+1;
      });
      const assemEntries = Object.entries(contPorAssem).sort((a,b)=> Number(a[0])-Number(b[0]) );
      const maxAssem = assemEntries.reduce((m, [,v])=> Math.max(m,v), 0);

      barsAssem.innerHTML = '';
      labelsAssem.innerHTML = '';
      assemEntries.forEach(([asm, qty])=>{
        const wrap = document.createElement('div');
        wrap.style.flex='1'; wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='center';
        const bar = document.createElement('div'); bar.className='bar';
        const span = document.createElement('span'); span.style.height = (maxAssem>0? Math.round((qty/maxAssem)*100):0) + '%';
        bar.appendChild(span);
        const lbl = document.createElement('div'); lbl.className='bar-label'; lbl.textContent = `#${asm}`;
        const num = document.createElement('div'); num.className='bar-num'; num.textContent = qty;
        wrap.appendChild(bar); wrap.appendChild(lbl); wrap.appendChild(num);
        barsAssem.appendChild(wrap);

        const pill = document.createElement('span');
        pill.className='pill'; pill.textContent = `Assembleia ${asm}: ${qty}`;
        labelsAssem.appendChild(pill);
      });

      // ---------- LANCES LIVRES (índices e telas) ----------
      const normalizeCotaKey = s => {
        if(!s) return '';
        const raw = String(s).trim();
        const num = raw.includes('-') ? raw.split('-')[0] : raw;
        const n = parseInt(num, 10);
        return isNaN(n) ? '' : String(n);
      };
      const toPct = s => {
        if(s == null) return NaN;
        const v = parseFloat(String(s).replace(',', '.'));
        return isNaN(v) ? NaN : v;
      };

      const byCota = {}; // cota -> { contemplacao:{asm,tipo}, lances:[{asm,valor}] }
      const byAssemLL = {}; // asm -> { lances, contLance }

      contemplacoes.forEach(c => {
        const key = normalizeCotaKey(c.Cota);
        if(!key) return;
        const asm = parseInt(c.Assembleia || c['Assem.'] || c['Asm'] || 0, 10) || 0;
        byCota[key] = byCota[key] || { contemplacao:null, lances:[] };
        byCota[key].contemplacao = { asm, tipo: (c.Tipo||'').trim() };
      });

      lancesLivres.forEach(l => {
        const key = normalizeCotaKey(l.Cota);
        if(!key) return;
        const asm = parseInt(l.Assembleia || l['Assem.'] || l['Asm'] || 0, 10) || 0;
        const v = toPct(l.Lance || l['Lance %'] || l['%'] || l['Lance(%)'] || l['Lance % (percentual)']);
        if(isNaN(v)) return;
        byCota[key] = byCota[key] || { contemplacao:null, lances:[] };
        byCota[key].lances.push({ asm, valor:v });

        byAssemLL[asm] = byAssemLL[asm] || { lances:0, contLance:0 };
        byAssemLL[asm].lances++;
      });

      contemplacoes.forEach(c => {
        const asm = parseInt(c.Assembleia || 0, 10) || 0;
        if((c.Tipo||'').trim()==='Lance'){
          byAssemLL[asm] = byAssemLL[asm] || { lances:0, contLance:0 };
          byAssemLL[asm].contLance++;
        }
      });

      // --- eventos UI lances livres
      const elIn = document.getElementById('ll-cota-input');
      const elBtn = document.getElementById('ll-cota-btn');
      const elMetrics = document.getElementById('ll-cota-metrics');
      const elChart = document.getElementById('ll-cota-chart');
      const elTable = document.getElementById('ll-cota-table');

      function renderCota(cotaInput){
        const key = normalizeCotaKey(cotaInput);
        const data = byCota[key];
        elTable.innerHTML = '';
        elChart.innerHTML = '';
        if(!data){
          elMetrics.textContent = 'Cota não encontrada nos dados de lances/contemplação.';
          return;
        }

        const asmCont = data.contemplacao?.asm ?? null;
        const tipoCont = data.contemplacao?.tipo ?? '—';

        const lancesOrdenados = data.lances.sort((a,b)=>a.asm-b.asm).filter(x => asmCont ? x.asm <= asmCont : true);

        const n = lancesOrdenados.length;
        const mai = n ? Math.max(...lancesOrdenados.map(x=>x.valor)) : null;
        const ult = n ? lancesOrdenados[lancesOrdenados.length-1].valor : null;

        elMetrics.textContent =
          `Contemplação: ${asmCont ?? '—'} (${tipoCont}) · ` +
          `Lances até a contemplação: ${n} · ` +
          `Maior: ${mai != null ? (mai+'%') : '—'} · ` +
          `Último: ${ult != null ? (ult+'%') : '—'}`;

        lancesOrdenados.forEach(x=>{
          const row = document.createElement('div');
          row.className='rowline';
          const badge = (asmCont && x.asm===asmCont && tipoCont==='Lance')
            ? '<span class="badge badge-win">Contemplado por Lance</span>'
            : '<span class="badge badge-pre">Pré-contemplação</span>';
          row.innerHTML = `
            <div>#${x.asm}</div>
            <div>Lance livre</div>
            <div style="text-align:right">${x.valor}%</div>
          `;
          if(asmCont && x.asm===asmCont){
            row.innerHTML += `<div style="grid-column: 1 / -1">${badge}</div>`;
          }
          elTable.appendChild(row);
        });

        if(n){
          const W=600, H=160, pad=24;
          const xs = lancesOrdenados.map(x=>x.asm);
          const ys = lancesOrdenados.map(x=>x.valor);
          const minX = Math.min(...xs), maxX = Math.max(...xs);
          const minY = 0, maxY = Math.max(50, Math.ceil(Math.max(...ys)/5)*5);

          const sx = v => pad + ( (v-minX)/(maxX-minX||1) ) * (W-2*pad);
          const sy = v => H-pad - ( (v-minY)/(maxY-minY||1) ) * (H-2*pad);
          const points = lancesOrdenados.map(p => `${sx(p.asm)},${sy(p.valor)}`).join(' ');

          elChart.innerHTML = `
            <svg viewBox="0 0 ${W} ${H}" class="svgblk" role="img" aria-label="Linha de lances por assembleia">
              <rect x="0" y="0" width="${W}" height="${H}" fill="transparent"/>
              ${[0,25,50,75,100].map(g=>`
                <line x1="${pad}" y1="${sy(g)}" x2="${W-pad}" y2="${sy(g)}" stroke="#223044" stroke-width="1" opacity="0.4"/>
                <text x="${W-pad+4}" y="${sy(g)+4}" fill="#8aa0b6" font-size="10">${g}%</text>
              `).join('')}
              <polyline fill="none" stroke="#4b89ff" stroke-width="2" points="${points}"/>
              ${lancesOrdenados.map(p=>`
                <circle cx="${sx(p.asm)}" cy="${sy(p.valor)}" r="3" fill="#4b89ff"/>
              `).join('')}
              ${asmCont ? `
                <line x1="${sx(asmCont)}" y1="${pad}" x2="${sx(asmCont)}" y2="${H-pad}" stroke="gold" stroke-width="2" />
                <text x="${sx(asmCont)+4}" y="${pad+10}" fill="gold" font-size="10">Asm ${asmCont}</text>
              ` : '' }
            </svg>
          `;
        }
      }

      elBtn.addEventListener('click', ()=> renderCota(elIn.value));
      elIn.addEventListener('keydown', e=>{ if(e.key==='Enter') renderCota(elIn.value); });
      (() => { // tenta sugerir cota inicial
        const pre = document.querySelector('.cell.lance, .cell.sorteio');
        if(pre){ elIn.value = pre.textContent.trim(); }
      })();

      // Resumo por assembleia (lances vs contemplações por lance)
      (function renderResumoAssembleia(){
        const entries = Object.entries(byAssemLL).sort((a,b)=> Number(a[0])-Number(b[0]));
        if(!entries.length) return;

        const W=700, H=160, pad=28;
        const maxLances = Math.max(...entries.map(([,v])=>v.lances));
        const maxCont   = Math.max(...entries.map(([,v])=>v.contLance));
        const maxY = Math.max(5, maxLances, maxCont);

        const bw = (W-2*pad)/entries.length - 4;
        const x = idx => pad + idx*((W-2*pad)/entries.length);
        const scale = v => (v/maxY) * (H-2*pad);

        const bars = entries.map(([asm, v], i) => {
          const h1 = scale(v.lances);
          const h2 = scale(v.contLance);
          return `
            <rect x="${x(i)}" y="${H-pad-h1}" width="${bw}" height="${h1}" fill="#4b89ff"/>
            <rect x="${x(i)+bw+2}" y="${H-pad-h2}" width="${bw}" height="${h2}" fill="green"/>
          `;
        }).join('');

        const axis = `<line x1="${pad}" y1="${H-pad}" x2="${W-pad}" y2="${H-pad}" stroke="#223044"/>`;

        document.getElementById('ll-assem-chart').innerHTML = `
          <svg viewBox="0 0 ${W} ${H}" class="svgblk" role="img" aria-label="Lances e contemplações por assembleia">
            <rect x="0" y="0" width="${W}" height="${H}" fill="transparent"/>
            ${axis}
            ${bars}
          </svg>
        `;
      })();

      // ---------- Donut (mix) ----------
      function renderDonutMix(pLance, pSorteio){
        const el = document.getElementById('mix-vis');
        if(!el) return;

        const size = 220, stroke = 28;
        const r = (size - stroke) / 2;
        const C = 2 * Math.PI * r;
        const lanceLen   = (pLance/100)   * C;
        const sorteioLen = (pSorteio/100) * C;

        el.innerHTML = `
          <div>
            <svg class="donut" viewBox="0 0 ${size} ${size}" role="img" aria-label="Lance ${pLance}%, Sorteio ${pSorteio}%">
              <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="#253041" stroke-width="${stroke}"></circle>
              <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="green" stroke-width="${stroke}"
                stroke-dasharray="${lanceLen} ${C-lanceLen}" stroke-linecap="butt"></circle>
              <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="gold" stroke-width="${stroke}"
                stroke-dasharray="${sorteioLen} ${C-sorteioLen}" stroke-dashoffset="${-lanceLen}" stroke-linecap="butt"></circle>
              <text x="${size/2}" y="${size/2}">${pLance}% / ${pSorteio}%</text>
            </svg>
            <div class="donut-legend">
              <div class="legend-item"><span class="legend-swatch swatch-lance"></span>Lance</div>
              <div class="legend-item"><span class="legend-swatch swatch-sorteio"></span>Sorteio</div>
            </div>
          </div>
        `;
      }

      // ---------- Grade: pintar cotas contempladas ----------
      let plotados = 0;
      contemplacoes.forEach(item=>{
        const raw = String(item.Cota||'').trim();
        let numeroCota = raw.includes('-') ? parseInt(raw.split('-')[0],10) : parseInt(raw,10);
        if(!isNaN(numeroCota) && numeroCota>=1 && numeroCota<=totalCelulas){
          const cell = document.getElementById('cell-'+numeroCota);
          if(cell){
            cell.textContent = raw || numeroCota;
            const tipo = String(item.Tipo||'');
            if(tipo==='Sorteio') cell.classList.add('sorteio');
            else if(tipo==='Lance') cell.classList.add('lance');
            plotados++;
          }
        }
      });
      pillTotal.textContent = `Contemplações plotadas: ${plotados}`;
    })
    .catch(err=>{
      console.error(err);
      alert('Erro ao carregar dados. Confira os nomes/paths dos JSONs e recarregue a página.');
    });
  </script>
</body>
</html>
