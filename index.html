<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Saúde do Grupo (Consórcio)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1216; --card:#151a21; --muted:#8aa0b6; --text:#e8eef6;
      --ok:#19a974; --warn:#f7b801; --bad:#ef476f;
      --gold:gold; --green:green;
      --grid-gap:6px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:16px; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell;
      background:var(--bg); color:var(--text);
    }
    h1{margin:0 0 8px 0; font-size:22px}
    .sub{color:var(--muted); font-size:12px; margin-bottom:16px}
    .wrap{display:grid; gap:12px}
    .cards{
      display:grid; grid-template-columns:repeat(4,minmax(200px,1fr)); gap:12px;
    }
    .card{
      background:var(--card); border:1px solid #202833; border-radius:12px; padding:14px;
      box-shadow:0 1px 0 rgba(255,255,255,0.03) inset, 0 10px 30px rgba(0,0,0,0.25);
    }
    .k-title{font-size:12px; color:var(--muted)}
    .k-value{font-size:22px; font-weight:700; margin-top:4px}
    .k-foot{font-size:11px; color:var(--muted); margin-top:6px}

    /* gráfico de barras simples (css only) */
    .bars{display:flex; gap:8px; align-items:flex-end; height:120px; padding:10px 6px}
    .bar{flex:1; background:#253041; border-radius:6px 6px 0 0; position:relative}
    .bar > span{
      position:absolute; bottom:0; left:0; right:0; height:0%;
      background:#4b89ff; border-radius:6px 6px 0 0; transition:height .6s ease;
    }
    .bar-label{font-size:11px; color:var(--muted); text-align:center; margin-top:6px; min-height:1em}
    .bar-num{font-size:12px; text-align:center; margin-top:2px}

    .two-col{display:grid; grid-template-columns: 1.3fr .7fr; gap:12px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}

    /* Grade 1..2000 */
    .grid{
      display:grid; grid-template-columns: repeat(10, 1fr);
      gap: var(--grid-gap);
      max-height:540px; overflow:auto; padding:6px; background:#0c0f13; border-radius:12px; border:1px solid #202833;
    }
    .cell{
      border:1px solid #2a3544; padding:8px 6px; text-align:center; font-size:11px; border-radius:8px; color:#bccde1;
      background:#121821;
    }
    .sorteio{ background-color: var(--gold); color:#1b1b1b; font-weight:700 }
    .lance{ background-color: var(--green); color:white; font-weight:700 }

    .legend{display:flex; gap:10px; font-size:12px; color:var(--muted); align-items:center}
    .dot{width:10px; height:10px; border-radius:3px; display:inline-block; vertical-align:middle}
    .dot-gold{ background:var(--gold)}
    .dot-green{ background:var(--green)}

    .list{margin-top:8px; display:grid; gap:6px; max-height:200px; overflow:auto}
    .pill{display:inline-block; background:#1a2330; border:1px solid #273246; padding:4px 8px; border-radius:999px; font-size:12px; color:#b9cee6}

    @media (max-width:1100px){
      .cards{grid-template-columns:repeat(2,minmax(160px,1fr))}
      .two-col{grid-template-columns: 1fr}
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <h1>Saúde do Grupo</h1>
  <div class="sub">Visão financeira e operacional do consórcio (Disponibilidades, Coleta/Utilização, Contemplações e Grade de Cotas).</div>

  <div class="wrap">

    <!-- KPIs -->
    <section class="cards" id="kpis">
      <div class="card">
        <div class="k-title">Disponibilidades (último fechamento)</div>
        <div class="k-value" id="kpi-dispon"></div>
        <div class="k-foot" id="kpi-dispon-ref"></div>
      </div>
      <div class="card">
        <div class="k-title">(+ ) Recursos Coletados (mês)</div>
        <div class="k-value" id="kpi-coletado"></div>
        <div class="k-foot" id="kpi-coletado-acc"></div>
      </div>
      <div class="card">
        <div class="k-title">(-) Recursos Utilizados (mês)</div>
        <div class="k-value" id="kpi-utilizado"></div>
        <div class="k-foot" id="kpi-utilizado-acc"></div>
      </div>
      <div class="card">
        <div class="k-title">Saldo do Mês (Coletado - Utilizado)</div>
        <div class="k-value" id="kpi-saldo"></div>
        <div class="k-foot" id="kpi-mix"></div>
      </div>
    </section>

    <section class="two-col">
      <!-- Mix Lance x Sorteio + parcela média -->
      <div class="card">
        <div class="k-title">Mix de Contemplações</div>
        <div class="bars" id="bars-mix" aria-label="Gráfico de barras: Lance x Sorteio">
          <div class="bar" title="Lance"><span id="bar-lance"></span></div>
          <div class="bar" title="Sorteio"><span id="bar-sorteio"></span></div>
        </div>
        <div class="row">
          <div>
            <div class="bar-label">Lance</div>
            <div class="bar-num" id="num-lance">0</div>
          </div>
          <div>
            <div class="bar-label">Sorteio</div>
            <div class="bar-num" id="num-sorteio">0</div>
          </div>
        </div>
        <div class="k-foot" id="parcela-media">Parcela média na contemplação: —</div>
      </div>

      <!-- Contemplações por Assembleia -->
      <div class="card">
        <div class="k-title">Contemplações por Assembleia</div>
        <div class="bars" id="bars-assem" aria-label="Barras por assembleia"></div>
        <div class="list" id="labels-assem"></div>
      </div>
    </section>

    <!-- Grade de cotas -->
    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <div class="k-title">Grade de Cotas (1 a 2000)</div>
        <div class="legend">
          <span class="dot dot-green"></span> Lance
          <span class="dot dot-gold"></span> Sorteio
          <span class="pill" id="pill-total"></span>
        </div>
      </div>
      <div class="grid" id="grid"></div>
    </section>

    <!-- Rodapé/Fontes -->
    <section class="card">
      <div class="k-title">Fontes</div>
      <div class="sub">
        Demonstrativo financeiro do grupo, contemplações e lances livres extraídos dos arquivos JSON anexados.
      </div>
    </section>
  </div>

  <script>
    // ===== Utils =====
    const BRL = v => (isNaN(v)? '—' : v.toLocaleString('pt-BR',{style:'currency', currency:'BRL'}));
    const pct = (a,b) => b>0 ? Math.round((a/b)*100) : 0;

    const safeFetchJson = async (path) => {
      const url = encodeURI(path);
      const r = await fetch(url);
      if(!r.ok) throw new Error('Falha ao carregar '+path);
      return r.json();
    };

    // ===== DOM refs =====
    const kpiDispon = document.getElementById('kpi-dispon');
    const kpiDisponRef = document.getElementById('kpi-dispon-ref');
    const kpiColetado = document.getElementById('kpi-coletado');
    const kpiColetadoAcc = document.getElementById('kpi-coletado-acc');
    const kpiUtilizado = document.getElementById('kpi-utilizado');
    const kpiUtilizadoAcc = document.getElementById('kpi-utilizado-acc');
    const kpiSaldo = document.getElementById('kpi-saldo');
    const kpiMix = document.getElementById('kpi-mix');

    const barLance = document.getElementById('bar-lance');
    const barSorteio = document.getElementById('bar-sorteio');
    const numLance = document.getElementById('num-lance');
    const numSorteio = document.getElementById('num-sorteio');
    const parcelaMedia = document.getElementById('parcela-media');

    const barsAssem = document.getElementById('bars-assem');
    const labelsAssem = document.getElementById('labels-assem');

    const grid = document.getElementById('grid');
    const pillTotal = document.getElementById('pill-total');

    // ===== Grade base 1..2000 =====
    const totalCelulas = 2000;
    for (let i = 1; i <= totalCelulas; i++) {
      const cell = document.createElement('div');
      cell.classList.add('cell');
      cell.id = 'cell-' + i;
      cell.textContent = i;
      grid.appendChild(cell);
    }
    const cell1603 = document.getElementById('cell-1603');
    if (cell1603) {
      cell1603.style.border = '2px solid #2c7df5';
    }

    // ===== Carregar dados =====
    Promise.all([
      safeFetchJson('DemonstrativoGrupo.json'),
      safeFetchJson('Contemplacoes.json'),
      safeFetchJson('LancesLivres.json'),
    ])
    .then(([demonstrativo, contemplacoes, lancesLivres]) => {
      // --- FINANCEIRO (pega último bloco de "Disponibilidades (Em: dd/mm/aaaa)")
      const dispRows = demonstrativo.filter(x => String(x['Discriminação']||'').trim().startsWith('Disponibilidades (Em:'));
      const lastDisp = dispRows[dispRows.length-1];
      const dispLabel = lastDisp?.['Discriminação'] || '';
      const dispValor = parseFloat(String(lastDisp?.['Saldo do Período']||'0').replace(/\./g,'').replace(',','.')) || 0;

      // Coletado / Utilizado do mês (pega primeira ocorrência do mês corrente na planilha)
      const rowColet = demonstrativo.find(x => String(x['Discriminação']||'').includes('(+ )') || String(x['Discriminação']||'').includes('(+) Recursos Coletados'));
      const coletPeriodo = rowColet ? parseFloat(String(rowColet['Saldo do Período']||'0').replace(/\./g,'').replace(',','.')) : 0;
      const coletAcc = rowColet ? parseFloat(String(rowColet['Saldo Acumulado']||'0').replace(/\./g,'').replace(',','.')) : 0;

      const rowUtil = demonstrativo.find(x => String(x['Discriminação']||'').startsWith('(-) Recursos Utilizados'));
      const utilPeriodo = rowUtil ? parseFloat(String(rowUtil['Saldo do Período']||'0').replace(/\./g,'').replace(',','.')) : 0;
      const utilAcc = rowUtil ? parseFloat(String(rowUtil['Saldo Acumulado']||'0').replace(/\./g,'').replace(',','.')) : 0;

      kpiDispon.textContent = BRL(dispValor);
      kpiDisponRef.textContent = dispLabel || '—';

      kpiColetado.textContent = BRL(coletPeriodo);
      kpiColetadoAcc.textContent = 'Acumulado: ' + BRL(coletAcc);

      kpiUtilizado.textContent = BRL(utilPeriodo);
      kpiUtilizadoAcc.textContent = 'Acumulado: ' + BRL(utilAcc);

      const saldoMes = coletPeriodo - utilPeriodo;
      kpiSaldo.textContent = BRL(saldoMes);

      // --- CONTEMPLAÇÕES (Lance x Sorteio, parcela média, por assembleia)
      const tipoCounts = { Lance:0, Sorteio:0 };
      let somaParcela = 0, contParcela = 0;

      contemplacoes.forEach(item => {
        const tipo = (item.Tipo||'').trim();
        if (tipoCounts.hasOwnProperty(tipo)) tipoCounts[tipo]++;

        const parc = parseInt(item.Parc || item['Parc.'] || item['Parcela'] || '0', 10);
        if (!isNaN(parc) && parc>0){ somaParcela += parc; contParcela++; }
      });

      const totalCont = (tipoCounts.Lance || 0) + (tipoCounts.Sorteio || 0);
      const pLance = pct(tipoCounts.Lance, totalCont);
      const pSorteio = pct(tipoCounts.Sorteio, totalCont);

      barLance.style.height = pLance + '%';
      barSorteio.style.height = pSorteio + '%';
      numLance.textContent = `${tipoCounts.Lance} (${pLance}%)`;
      numSorteio.textContent = `${tipoCounts.Sorteio} (${pSorteio}%)`;

      parcelaMedia.textContent = 'Parcela média na contemplação: ' + (contParcela>0 ? Math.round(somaParcela/contParcela) : '—');

      kpiMix.textContent = `Mix: Lance ${pLance}% · Sorteio ${pSorteio}% (total ${totalCont})`;

      // --- Por assembleia (count)
      const byAssem = {};
      contemplacoes.forEach(i=>{
        const a = String(i.Assembleia||'').trim();
        if(!a) return;
        byAssem[a] = (byAssem[a]||0)+1;
      });
      const assemEntries = Object.entries(byAssem).sort((a,b)=> Number(a[0])-Number(b[0]) );
      const maxAssem = assemEntries.reduce((m, [,v])=> Math.max(m,v), 0);

      barsAssem.innerHTML = '';
      labelsAssem.innerHTML = '';
      assemEntries.forEach(([asm, qty])=>{
        const wrap = document.createElement('div');
        wrap.style.flex='1'; wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='center';
        const bar = document.createElement('div');
        bar.className='bar';
        const span = document.createElement('span');
        span.style.height = (maxAssem>0? Math.round((qty/maxAssem)*100):0) + '%';
        bar.appendChild(span);
        const lbl = document.createElement('div');
        lbl.className='bar-label'; lbl.textContent = `#${asm}`;
        const num = document.createElement('div');
        num.className='bar-num'; num.textContent = qty;
        wrap.appendChild(bar); wrap.appendChild(lbl); wrap.appendChild(num);
        barsAssem.appendChild(wrap);
        // legenda textual
        const pill = document.createElement('span');
        pill.className='pill'; pill.textContent = `Assembleia ${asm}: ${qty}`;
        labelsAssem.appendChild(pill);
      });

      // --- Grade 1..2000 mapeando contemplações
      let plotados = 0;
      contemplacoes.forEach(item=>{
        const raw = String(item.Cota||'').trim();
        // "0199-00" -> 199
        let numeroCota = NaN;
        if(raw.includes('-')) numeroCota = parseInt(raw.split('-')[0], 10);
        else numeroCota = parseInt(raw, 10);

        if(!isNaN(numeroCota) && numeroCota>=1 && numeroCota<=totalCelulas){
          const cell = document.getElementById('cell-'+numeroCota);
          if(cell){
            cell.textContent = raw || numeroCota;
            if((item.Tipo||'')==='Sorteio') cell.classList.add('sorteio');
            else if((item.Tipo||'')==='Lance') cell.classList.add('lance');
            plotados++;
          }
        }
      });

      pillTotal.textContent = `Contemplações plotadas: ${plotados}`;

      // (Opcional) usar LancesLivres futuramente para análises específicas de taxa/parcela
      // console.log('LancesLivres exemplos:', lancesLivres.slice(0,5));
    })
    .catch(err=>{
      console.error(err);
      alert('Erro ao carregar dados. Confira os nomes dos JSONs e recarregue a página.');
    });
  </script>
</body>
</html>
